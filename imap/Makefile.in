ACL=acl_afs.o
AUTH=auth_krb.o
AUTHLIBS=/usr/local/lib/libkrb.a

LOBJS= append.o mailbox.o message.o xmalloc.o \
	parsel.o parsey.o parseadd.o parseutl.o \
	imap_err.o assert.o \
	$(ACL) $(AUTH)

COMPILE_ET=compile_et

CFLAGS= $(OPT) $(INCLUDES) $(DEFINES)

OPT=-g
INCLUDES= -I../lib -I/usr/local/include -I/usr/local/include/afs
LIBS=../lib/libcyrus.a /usr/local/lib/libcom_err.a $(AUTHLIBS)

deliver: deliver.o libimap.a
	$(CC) $(CFLAGS) -o deliver deliver.o libimap.a $(LIBS)

libimap.a: $(LOBJS)
	ar cr libimap.a $(LOBJS)
	ranlib libimap.a

.y.o:
	$(YACC) $*.y
	rm -f $*.c
	mv y.tab.c $*.c
	$(CC) -c $(CFLAGS) $*.c
	rm -f $*.c

.l.o:
	$(LEX) $*.l
	rm -f $*.c
	mv lex.yy.c $*.c
	$(CC) -c $(CFLAGS) $*.c
	rm -f $*.c

parsel.o: parsey.h

parsey.c parsey.h: parsey.y
	$(YACC) -d parsey.y
	rm -f parsey.c parsey.h
	mv y.tab.c parsey.c
	mv y.tab.h parsey.h

imap_err.h imap_err.o: imap_err.et
	$(COMPILE_ET) imap_err.et
	$(CC) $(CFLAGS) -c imap_err.c

clean:
	rm -f *.o *.a parsey.c parsey.h parsel.c deliver
	rm -f testmkdir

depend:
	grep '^#[ 	]*include[ 	]*"' *.[ch] | \
	sed -e 's/:[^"]*"\([^"]*\)"/:	\1/' -e 's/\.c/.o/' | \
	awk ' { if ($$1 != prev) { print rec; rec = $$0; prev = $$1; } \
		else { if (length(rec $$2) > 78) { print rec; rec = $$0; } \
		       else rec = rec " " $$2 } } \
	      END { print rec } ' > makedep
	echo '/^# DO NOT DELETE THIS LINE/+2,$$d' >eddep
	echo '$$r makedep' >>eddep
	echo 'w' >>eddep
	cp Makefile Makefile.bak
	ed - Makefile < eddep
	rm eddep makedep
	echo '' >> Makefile
	echo '# DEPENDENCIES MUST END AT END OF FILE' >> Makefile
	echo '# IF YOU PUT STUFF HERE IT WILL GO AWAY' >> Makefile
	echo '# see make depend above' >> Makefile

# DO NOT DELETE THIS LINE -- make depend uses it


acl_afs.o:	xmalloc.h
append.o:	imap_err.h mailbox.h message.h
deliver.o:	imap_err.h mailbox.h
mailbox.o:	imap_err.h mailbox.h xmalloc.h
message.o:	mailbox.h parseadd.h xmalloc.h
parseutl.o:	parseadd.h
parsey.o:	parseadd.h
testmkdir.o:	mailbox.h

# DEPENDENCIES MUST END AT END OF FILE
# IF YOU PUT STUFF HERE IT WILL GO AWAY
# see make depend above
