<!-- $Id: changes.html,v 1.41 1998/06/24 15:39:12 dar Exp $ -->

<HTML><HEAD>
<TITLE>Changes to the Cyrus IMAP Server</TITLE>
</HEAD><BODY>
<H1>                   Changes to the Cyrus IMAP Server</H1>

<h2> Changes to the Cyrus IMAP Server Since Version 1.5.10</h2>

<ul>

<li> If ENABLE_EXPERIMENT is set, the server no longer claims to support
OPTIMIZE-1; instead, it claims to support UIDPLUS.  The Getuids command has
been removed since it is not in the UIDPLUS document
(draft-myers-imap-optimize-03.txt).

<li> The checks for Tcl in configure are much smarter.  The configure script
asks tclsh where its configuration lives, then consults the shell scripts that 
have that information.  This should work with 7.5 or better, which is what the 
server requires anyway.  (All the previous checks to look for Tcl
	libraries are gone; now, configure runs tclsh and asks it where
	the Tcl libraries are, then runs the shell scripts that are in
	that directory.)

<li> The checks for com_err in configure are a little smarter and look
	to see if all the pieces are there before trying to use them.

<li> Added support for the NAMESPACE extension (if --enable-experiment is
	supplied).

<li> Added a "reject8bit" switch to imapd.conf.  If set to "true", messages
	containing 8-bit-set characters in the headers are rejected (the
	previous behavior); if set to "false" or left to the default value,
	messages containing 8-bit-set characters have these characters changed 
	to a constant character ('X').

<li> Added the "fud" program.   This is an interm hack designed to allow
	allow finger information to be retrieved for cyrus users.  This
	is experimental and it is not recommend that services be built
	arround this feature, since it is likely to be removed in a
	future release of the IMAP server.

</ul>

<h2>Changes to the Cyrus IMAP Server Since Version 1.5.2</h2>

<ul>

<li> Patches from John Myers, including more glob fixes.

<li> Use the default hash function from DB. Note that this means that
	  the existing <tt>delivered.db</tt> and <tt>ptscache.db</tt>
	  is <b>NOT</b> compatible with this release. 

<li> Provide two debugging programs that dump the databases:
	  <tt>ptdump</tt> and <tt>dump_deliverdb</tt>.

<li> Multiple changes to ptloader. added a bunch of flags; let it
	  reauthenticate on its own; added support perl wrapper; added
	  bunch of debugging information/output; bunch of other cleanups

<li> The mailboxes file is now closed if it isn't likely to be referenced,
	  hopefully preventing old mailboxes files from hanging around in
	  memory as frequently.

<li> Added a patch from Eric Hagberg to work around a possible deadlock
	  condition in mboxlist.c where rename isn't atomic.

<li> Patch from John Myers to get rid of cyrus.seen corruption in
	  bsearch_mem.

<li> Patch from John Myers and to allow ISO-8859-1 characters in
	  mailbox names.

<li> Makedepend still runs, and still generates warnings, but these are
	  squirrled away in makedepend.log.

<li> On mailbox delete, the server will no longer try and unlink ".." and
	  "." as we got a report that it seriously breaks one file system
	  (even as non-root).

<li> Added some support for Netscape's very misleading "Administrate My
	  Mail" menu option in Communicator.  Allows for a URL to be set in
	  imapd.conf for the page to refer users to; needs to be turned on
	  with --enable-netscapehack at compile time to enable it.

<li> Bug swap: imtest quotes password with a non-synchronizing literal in
order to allow weird characters like ) in passwords.  But it doesn't
look to see if the server supports non-synchronizing literals.

<li> If the file "<TT>msg/motd</TT>" exists, the first line is now sent to
clients upon login.

<li> Bug fix: to handle BODY[] properly when fetching news articles
(truncation no longer occurs). (thanks to John Prevost)

<li> The makedepend supplied should now run on Solaris Intel.  (thanks to
Chris Newman)

<li> Added some hacks to pwcheck.c for Linux and Digital Unix where the
default protections on the socket don't allow the cyrus user to read it.
(thanks to Lyndon Nerenberg)

<li> Bug fix: Flags beginning with \ are system flags and users can
only create the defined flags.  The code to do this before was
confused.

<li> The configure scripts and makefiles have some random fixes.

<li> ptloader can now renew its AFS authentication by reading from a srvtab
	  file.

<li> The configure script now looks for a libcom_err and can use an
	  installed one if one exists.

<li> Other small bug fixes.

</ul>

<h2>Changes to the Cyrus IMAP Server Since Version 1.5</h2>

<ul>

<li>Bug fix: RENAME corrupted mailboxes if they had been EXPUNGEd.  (may
have only happened with INBOX, which Pine tickles once a month.)

<li>Bug fix: auth_newstate now initializes its structures.

<li>Bug fix: pop3d.c, a printf was changed to prot_printf.

<li>Cyrus now sends X-NON-HIERARCHICAL-RENAME to alert clients that it is
not handling RENAME in an IMAP4rev1 compliant manner.  This will be fixed
in a subsequent release.

<li>Bug fix: imclient_autenticate now does resolution on the hostname
before authenticating to it.  This caused problems when
authenticating to an address that was a CNAME.

<li>Bug fix: LIST %.% (and other multiple hierarchy delimiter matches)
works properly.  Several other glob.c fixes are included as well.

<li>Bug fix: a fetch of exclusively BODY[HEADER.FIELDS...] should now
work properly.

<li> Bug fix: reconstruct now considers a nonexistant INN news directory
        to be empty; this makes reconstruct fix the cyrus.* files in the
        imap news partition.

<li> Added a manpage for imclient.

<li> Fixed a few other minor bugs.

</ul>

<h2>Changes to the Cyrus IMAP Server Since Version 1.4</h2>

<ul>

<LI> Implemented the "<TT>IMAP4rev1</TT>" protocol commands.  
(The hierarchical behavior of RENAME, which was added late to the
IMAP4rev1 specification, is not implemented.)
Changes
the minor version number of the cyrus mailbox database format to 1.
<B>IMPORTANT:</B> it is necessary to run the command "<TT>reconstruct
-r</TT>" as the cyrus user after upgrading the Cyrus IMAP software
from version 1.4 or earlier.

<LI> If the file "<TT>msg/shutdown</TT>" exits in
the configuration directory, the IMAP server will issue the first line
in the file in an untagged BYE message and shut down.

<LI> Permit SPACE in mailbox names.

<LI> Permit the "modified UTF-7" internationalized mailbox name convention.

<LI> "User opened mailbox" messages are now logged at the DEBUG level
instead of the INFO level.

<LI> Added <tt>-q</tt> (ignore quota) switch to <tt>deliver</tt>.

<LI> New "<TT>krbck</TT>" program for diagnosing common kerberos problems.

<LI> auth_unix no longer requires users to be in the passwd file.

<LI> AUTHENTICATE command now reports the protection mechanism in use
in the text of the tagged OK response

<LI> Make MAILBOX_BADFORMAT and MAILBOX_NOTSUPPORTED temporary errors.

<LI> Use the header cache for SEARCH HEADER

<LI> Use "unspecified-domain" instead of server's hostname to fill out
RFC 822 addresses without the "@domain" part.

<LI> Make "reconstruct -r" with no args reconstruct every mailbox.

<LI> The configure script now defaults to using unix_pwcheck instead
of unix if the file /etc/shadow exists.

<LI> The location of the pwcheck socket directory now defaults to
"<TT>/var/ptclient/</TT>".  It is controlled by the
"<TT>--with-statedir=DIR</TT>" option, which defaults to
"<TT>/var</TT>".

<LI> Bug fix: by using an certain address form, one could deliver to a
user's mailbox bypassing the ACL's.

<LI> Bug fix: un-fold header lines when parsing for the ENVELOPE.

<LI> Delete quota roots when deleting the last mailbox that uses them.
Doesn't catch all cases, but should get over 99% of them.

<LI> Implement plaintextloginpause configuration option, imposes
artificial delay on plaintext password logins.

<LI> Implement popminpoll configuration option, limits frequency of
POP3 logins.

<LI> Implement AFS PT server group support.

<LI> Remove persistence of POP3 LAST value and remove Status: hack

<LI> Support the new ACL command set in the IMAP server.

<LI> Bug fix: Have to initialize reply to 0 in pop3d.  Was causing
POP3 server to occasionally drop the connection during authentication.

<LI> Bug fix: The COPY command wasn't issuing a [TRYCREATE] when
appropriate for sub-mailboxes of INBOX.

<li> Bug fix: Renaming a mailbox wasn't correctly changing its
UIDVALIDITY.

<li> Bug fix: Renaming a mailbox to itself, in order to move it to a
different partition, was not working correctly.

<li> Update the AUTH support in pop3d to conform to the latest draft
specification.

<LI> Update cyradm to use Tcl 7.5 instead of Tcl 7.4

<LI> Re-implement large sections of the netnews support.  It no longer
requires modifications to INN, as it now expunges the index entries
for expired/canceled articles upon select of the newsgroup.

<LI> Implement newsspool configuration option, for separating the
directories for the news spool and the various cyrus.* IMAP server
index files.

<LI> Bug fix: permit empty flag list in APPEND command

<LI> Bug fix: deal with truncated Date: header values.

<LI> Bug fix: memory mapping code, deal better with 0-length maps, since
mmap() appears to crap out on that boundary condition.

<LI> Portability fix: if no strerror, have to define NEED_SYS_ERRLIST.

<LI> Bug fix: used append instead of lappend in cyradmin, preventing
use of any port other than IMAP.

<LI> When the client is streaming its commands, the IMAP server attempts
to stream its tagged responses.

<LI> Modify zephyr support to compile without Kerberos support.

<LI> Add a bunch of prototype declararations to the code.

<LI> In deliver, change the MULT support to instead use the LMTP syntax.

<li> imclient: support tagged intermediate replies and a default
callback.

<LI> Implement some experimental protocol extensions for optimizing
disconnected use resynchronization.  Most extensions are disabled by
default.  Client authors should contact info-cyrus@andrew.cmu.edu if
they wish to experiment with these.

<LI> In Makefiles, change $(AR) to ar -- HPUX make is defective.

<LI> In deliver, use HAVE_LIBDB to select use of db over dbm

<LI> Add map_stupidshared mapping module for older versions of Digital
Unix.  It's not quite as bad as HPUX, but...

<LI> Bug fix: in imclient.c, don't free NULL pointers and don't call
htons() on the output of getservbyname().  Have to abort sending
the command if you get a tagged response when sending a literal.

<LI> The auth_xxx routines now create/take a state argument instead of
maintaining internal static state.

<LI> Solaris mktime() is buggy in some releases.  Create and use
mkgmtime() for parsing date strings.

<LI> Message parsing routines now use memory mapping, though they
still copy data around in line-sized buffers.

</ul>

<h2>Changes to the Cyrus IMAP Server Since Version 1.3</h2>

<ul>

<LI> Implemented the "<TT>reconstruct -m</TT>" command, for
reconstructing the <TT>mailboxes</TT> file.  <B>IMPORTANT:</B> it is
necessary to run the command "<TT>reconstruct -m</TT>" as the cyrus
user after upgrading the Cyrus IMAP software from version 1.3 or
earlier.  We recommend you make a backup copy of the
<TT>mailboxes</TT> file in the configuration directory before
performing the conversion.

<LI>Mailbox names are now case
sensitive, not case insensitive.  "<TT>INBOX</TT>" is the exception, and is treated as being case-insensitive.

<LI> Personal mailboxes now appear to their owners as being under the
"<TT>INBOX.</TT>" hierarchy.  For example, the mailbox
"<TT>user.bovik.work</TT>" appears to the user "<TT>bovik</TT>" as
"<TT>INBOX.work</TT>".  The user may still refer to the mailbox with the name
"<TT>user.bovik.work</TT>".

<LI> Previously, the code used "<TT>anybody</TT>" as the name of the
group that all users are in, but the documentation used the name
"<TT>anyone</TT>".  Changed the code to match the documentation.
The name "<TT>anybody</TT>" will be canonicalized to the name
"<TT>anyone</TT>".

<LI> The install document now gives different recommended locations
for the server databases.  The recommended location of the
configuration directory changed from "<TT>/usr/cyrus</TT>" to
"<TT>/var/imap</TT>" and the recommended location of the default
partition directory changed from "<TT>/usr/spool/cyrus</TT>" to
"<TT>/var/spool/imap</TT>".  It is <B>NOT</B> necessary to change the
locations of these directories when upgrading from version 1.3 or
earlier of the Cyrus IMAP server software.  If you do wish to change
the locations of these directories to match the new recommendations,
simply rename the directories and change the appropriate values in
your <TT>/etc/imapd.conf</TT> file.

<LI>Created a "<TT>make install</TT>" rule.  See the <a
href="install.html">installation</a> document for all the new
corresponding <TT>configure</TT> options.  Note the recommended
location of the "<TT>imapd</TT>", "<TT>pop3d</TT>", and
"<TT>deliver</TT>" programs has changed, this change needs to be
reflected in the "<TT>inetd.conf</TT>" and "<TT>sendmail.cf</TT>"
files.

<LI>New "<TT>login_unix_pwcheck</TT>" module and "<TT>pwcheck</TT>"
daemon, for improved shadow password support.   See the
"<TT>pwcheck/README.pwcheck</TT>" file in the distribution for details.

<LI>Renamed the "<TT>login_unix_shadow</TT>" module to
"<TT>login_unix_getspnam</TT>".

<LI>Added a mail notification mechanism, using Zephyr.

<LI>Added a feature to automatically create user IMAP accounts.
Controlled by the "<TT>autocreatequota</TT>" config option.

<LI>Added the "<TT>logtimestamps</TT>" config option, for putting
timestamp information into protocol telemetry logs.

<LI>Beefed up the Kerberos checks in Configure to ensure the DES library
routines exist.

<LI>On some systems, the "<TT>echo</TT>" command with no arguments
emits a newline.  Changed the installation document to instead use the
"<TT>true</TT>" command to create the "<TT>mailboxes</TT>" file.

<LI>Store a redundant copy of a mailbox's ACL in the <TT>cyrus.header</TT>
file, so "<TT>reconstruct -m</TT>" may later use it as a backup.

<LI>Had to remove the declaration of <TT>tcl_RcFileName</TT> for
the latest version of Tcl.

<LI>Make much more extensive use of memory mapping.  Replace the
binary search module with one that searches a memory mapped area.

<LI>Replaced the yacc-based RFC822 address parser with a hand-coded one.

<LI>Replaced the et (error table) libary with a version that doesn't
require lex or yacc.  Remove the lex/yacc checking from Configure.

<LI>Safety feature: most programs now refuse to run as root.

<LI>Bug fix: Issue [TRYCREATE] tag on COPY command when appropriate.

<LI>Bug fix: The quoted-printable decoder wasn't ignoring trailing
whitespace, as required by MIME.

<LI>Bug fix: Don't spew cascade errors if the server gets an EOF
during/after reading an APPEND literal.

<LI>Bug fix: gmtmoff_gmtime.c was returning results with the wrong sign.

<LI>Bug fix: imclient_send was appending spaces to %d and %u and the
response parser was not handling responses that did not contain a
space after the keyword.

<LI>Bug fix: rmnews wasn't removing some (un-indexed) article files
correctly.

<LI>Completely disabled the dropoff code for now.  It will be
completely replaced when IMSP integration is implemented

<LI>Added workaround for the Linux mkdir() problem.

<LI>In Configure, use a more direct test for a working shared-memory mmap

<LI>In collectnews, avoid O(n**2) behavior when processing articles
that have already expired.

<LI>Bug fix: append_addseen() would screw up if no messages were
previously seen.

<LI>Added the CMU-specific amssync and cmulocal directories.

<LI>Use memmove instead of bcopy.

<LI>Implemented the first pass of SMTP/MULT support in deliver.

<LI>Added cacheid parameter to auth_setid(), for AFS PT server support.

</ul>

<h2>Changes to the Cyrus IMAP Server Since Version 1.2</h2>

<ul>

<li>Fixed bug in character set code that broke text searches.  Sites
which care about searching headers need to reconstruct their existing
mailboxes.

</ul>

<h2>Changes to the Cyrus IMAP Server Since Version 1.1-Beta</h2>

<ul>

<li>Add support for <tt>UIDVALIDITY</tt> special information token.

<li>Add <tt>syncnews</tt> and <TT>arbitron</TT> programs.

<li>Redo duplicate delivery elimination in <tt>deliver</tt>.

<li>Bug fixed: Must re-read files after acquiring a lock.  Cannot
trust the mtime of a file to increment when writing the file--file
could be written to multiple times in the same second.

<li>Bug fixed: <tt>EXAMINE</tt> command should not affect
<tt>\Recent</tt> status.

<li>Update the user's <tt>\Recent</tt> high-water-mark when we report
new messages.

<li>Portability changes

<li>Upgrade to autoconf 2.1

<li>Allow privacy to be turned off at compile-time with
<TT>--disable-privacy</TT> configure switch.

<li>Fix typo in <tt>cyradm</tt> preventing "<tt>all</tt>" from being
recognized.

<li>Include <TT>map_private.c</TT> memory mapping module for systems like HPUX
which have half-working <TT>mmap()</TT> implementations.

<li>Switch to using UTF-8 for internal search format.  Sites which
care about internationalized searching of headers need to reconstruct
all their existing mailboxes.

<li>Fix some errors in the iso-8859-* tables.

<li>Add and correct a bunch of case-independence mappings in the
character tables.

<li>First pass at implementing the <TT>STATUS</TT> extension; disabled for
release.

<li> First pass at implementing IMAP/IMSP server integration.  Not
ready for general use.

<li>Add <TT>new_cred</TT> and <TT>free_cred</TT> mechanisms to
authentication modules.

<li>Don't complain when doing "<tt>reconstruct -r foo</tt>" and
<tt>foo</tt> isn't a mailbox.

<li>Add <tt>IMAP_QUOTAROOT_NONEXISTENT</tt> error code.

<li>Bug fix: Avoid divide by zero when quota is zero

<li>Bug fix: In an error case of the ACL handling code, we have to
restore tab before breaking out of loop.

<li>Fix file descriptor leak in quota system.

<li>Change a bunch of int variables to unsigned.

<li>Better error reporting on reads that end up short.
</ul>

<h2>Changes to the Cyrus IMAP Server Since Version 1.0-Beta</h2>
<p>
<ul> 
<li>Improved <a href="install.html">installation</a> document.
<li>New "<a href="cyradm.1.html"><tt>cyradm</tt></a>" administrative client.
<li>Changed the syslog facility from "<a href="install.html#syslog"><tt>local4</tt></a>" to "<tt>local6</tt>".
<li>Removed the <tt>renounce setuid</tt> check in "<a href="install.html#deliver"><tt>deliver</tt>"</a>.  The "<tt>deliver</tt>" program
  must now be <b>non</b>-executable by <tt>other</tt>.
<li>Fixed a typo in the parsing of <tt>SEARCH DELETED</tt>.
  (This bug constantly got tripped by newer C-clients.)
<li>Redesigned the implementation of <tt>SEARCH CHARSET</tt>.<br>
  Sites that wish to search for non-ASCII characters
  in the headers of existing mailboxes must run <tt>reconstruct</tt>
  on all their mailboxes after upgrading to this version.
<li>Added AUTH and KPOP support to the POP3 server.
<li>Added search support for the ISO-2022-JP character set.
<li>Replaced the search engine with a partial Boyer-Moore algorithm.
<li>Special-case optimized searching US-ASCII text.
<li>Fixed a bug which caused the message parser to spin-loop on a
  particular degenerate invalid-MIME case.
<li>Fixed a performance bug in the message parser.
<li>Tracked last-minute changes to the IMAP4 protocol.
<li>Fixed a bug in <tt>UNSUBSCRIBE</tt> which caused too many subscriptions to
  be removed.
<li>Added a bunch more "<a href="install.html#configure"><tt>configure</tt></a>" options.
<li>Ported to HPUX.
<li>Fixed a bug in the <tt>LIST/LSUB \Noselect</tt> code.
<li>Fixed bug in the globbing code which caused the "<tt>*%</tt>" pattern to work
  incorrectly.
<li>Client-side Kerberos support is now conditionalized on
  <tt>HAVE_ACTE_KRB</tt>, which is set by configure.
<li>Fixed some invalid buffer-alignment assumptions in the Kerberos code.
<li>Made the lexers compatible with flex.  Configure now looks for and
  prefers to use <tt>flex</tt> and <tt>bison</tt>/<tt>byacc</tt>.
<li>Made the IMAP server check for the existence of the mailboxes file
  upon startup, in order to give a more informative error message for
  this common configuration error.
<li>Fixed other minor bugs.
</ul>
<P><HR><P>
<!-- hhmts start -->
last modified by tjs at Wed Jun 10 18:03:47 1998
<!-- hhmts end -->
<br>
<A HREF="index.html">Return</A> to the Cyrus IMAP Server Home Page
</BODY></HTML>
