<!-- $Id: install.html,v 1.83 2000/04/10 00:33:59 leg Exp $ -->
<HTML>
<HEAD>
<TITLE>Installing and Configuring the Cyrus IMAP Server</TITLE>

</HEAD>
<BODY>
<h1>           Installing and Configuring the Cyrus IMAP Server</h1>

<P>The Internet Message Access Protocol (IMAP) is an Internet
standards-track protocol for accessing messages (mail, news, etc).
The IMAP server stores and provides access to messages.

<P>A list of answers to common installation problems is maintained in
<A
HREF="http://asg.web.cmu.edu/cyrus/imapd/install-FAQ.html">http://asg.web.cmu.edu/cyrus/imapd/install-FAQ.html</A>.
It is very out of date and will eventually be updated. The file <a
href="questions.html">doc/html/questions.html</a> contains a list of
questions we'd like to answer but haven't gotten to yet.

<P>Feedback on the software or on the document may be sent to
"<tt>cyrus-bugs@andrew.cmu.edu</tt>".  The
<tt>info-cyrus@andrew.cmu.edu</tt> mailing list exists for the
discussion of this server and other Cyrus software; more information
is available <a href="mailing-list.html">in the mailing-list
document</a>.  Be sure to include the version numbers of imapd and
libsasl you are using, as well as your system type (and version!) and
any configuration options you selected.

<p>For detailed changes, refer to the file <a
HREF="changes.html"><TT>doc/changes</TT></a> in the distribution. 

<h2>Upgrading From Previous Versions</h2>

<h3>Upgrading from 1.6</h3>
<ul>

<li> Upgrading from the Cyrus IMAP server version 1.6.13 or earlier:
if you use Sieve, you should run the "<tt>tools/upgradesieve</tt>"
script, as the format of the "<tt>/usr/sieve</tt>" directory has
changed slightly.

timsieved, included in this release, will handle maintenance of Sieve
scripts.

<li> Upgrading from the Cyrus IMAP server version 1.6.10 or earlier:
if you export news via the IMAP server, you'll have to change your
"<tt>newsfeeds</tt>" file to contain
<pre>collectnews!:*:Tf,WR:collectnews</pre>  The format of the
input to collectnews has changed.

Duplicate delivery suppression is now required for Sieve.

<li> Upgrading from the Cyrus IMAP server version 1.6.1 or earlier
(including 1.5.x!): the quota and user directories are now hashed by
the first character of the username.  This is to reduce the number of
entries in any given directory. It doesn't do a great job (and in some
cases it will do a really poor job) but as a quick hack it shouldn't
make things worse.  Optionally, the data partitions can also be hashed
by enabling the "hashimapspool" option.

<p>You must hash your directories using the "<tt>dohash</tt>" script
in the tools subdirectory.  (If you want to hash your mail spool, be
sure to set "hashimapspool" before running "<tt>dohash</tt>".)  This
must be run as the Cyrus user. Be sure to stop mail service while
converting. Doing this in single user mode is probably the safest.

</ul>

<h3>Upgrading from 1.5</h3>
<ul>
<li> Upgrading from the Cyrus IMAP server version 1.5 or earlier:
libsasl is now required.  Configuring SASL to work may be a chore,
especially if you use shadow passwords.

<li> An ANSI C compiler is now required.  gcc should work fine and can
be acquired from <a href="http://www.gnu.org/software/gcc/gcc.html">
http://www.gnu.org/software/gcc/gcc.html</a>.

<li> Make sure to read the upgrading instructions under 1.6 above.

<li> Upgrading from 1.5.14 or earlier requires deleting the delivered
database.  Remove the file delivered.db in the configdirectory and make a
directory called "deliverdb" in the configdirectory.  This may cause some
duplicates to get through.

<li> Upgrading from 1.5.14 or earlier requires removing the PTS cache
database (if the AFS PTS group support is used, which is not the
default).  The PTS cache is in /var/ptclient/ptscache.db, and you
should remove it. This is because the format for the PTS cache for
IMSP has changed.  If you use AFS ACLs, IMSPd, and IMAPd on the same
machine, make sure you have version 1.5a5 of the IMSP server for this
version of the IMAP server.  (If you don't have IMSP, or AFS, don't
worry about it.)

</ul>

<H2>Prerequisites and other notes</H2>

<P>The following programs and/or packages are <b>required</b>.

<ul>
<LI> <b>libsasl</b>, version 1.5.15 or higher.  To obtain libsasl, ftp
it from <a
href="ftp://ftp.andrew.cmu.edu/pub/cyrus-mail"><TT>ftp.andrew.cmu.edu</TT></a>.
Earlier versions of SASL will not work; please get the latest one.
Configure SASL so that it supports whatever authentication method your
site uses.  It is recommended that if you have PAM, you configure SASL
to use PAM.

<li> <b>Berkeley DB</b>, version 3.0.55 or higher. Berkeley DB can be
obtained from <a href="http://www.sleepycat.com">Sleepycat</a>.

<li> <b>GNU Make</b> is required.  Get it from <a
href="http://www.fsf.org/">the Free Software Foundation</a>.
</ul>

The following programs and/or packages are required for specific
features.  If you don't have them, certain features of the IMAP server
will be disabled.

<ul>
<LI> <b>makedepend</b>.  A version is included in the
<TT>makedepend</TT> subdirectory of the distribution.  Try and install
it before installing the Cyrus IMAPd.  If it fails, the configure
script will use a dummy shell script instead of makedepend, and you
should be sure to always give the command "<TT>make clean</TT>" before
"<TT>make all</TT>". If you don't plan on doing any development, this
isn't a big deal.

<LI> <b>Tcl</b>, version 7.5 or 7.6, or 8.0.  To obtain Tcl, see the
<A
HREF="ftp://rtfm.mit.edu/pub/usenet/comp.lang.tcl"><TT>comp.lang.tcl</TT>
FAQ</A>.  Other versions of Tcl might work, but it must be at least
Tcl 7.5.  (Tcl 7.4 ships with some Unix variants, and it is not
sufficient.), for the older <tt>cyradm</tt>.

<LI> <b>Perl</b>, version 5.  To obtain Perl, see <a
href="http://www.cpan.org/">the comprehensive Perl archive</a>.  This
is required for the newer version of <tt>cyradm</tt> written by
Brandon Allbery.  It is also used for some installation scripts: you
don't need it but it may make your life easier.

<li> <b>OpenSSL</b>, version 0.9.4 or higher.  Required for STARTTLS
support and eventually for IMAP wrapped in SSL (the imaps port).
Available from <a href="http://www.openssl.org/">http://www.openssl.org/</a>.

<LI> If you use AFS PTS support for groups, Cyrus still depends on
Kerberos and AFS.  If you successfully compiled SASL with your
Kerberos library, it's likely that it will work well with Cyrus.

<LI> We recommend using an MTA (mail transfer agent) that supports
LMTP (local mail transfer protocol).  We use Sendmail and recommend
version 8.10.0 or higher, available from <A
HREF="http://www.sendmail.org">http://www.sendmail.org</a>.  Others
have reported success with
<href="http://www.postfix.org/">Postfix</a>.

<LI> If you want to export netnews newsgroups using IMAP, the IMAP
server must receive newsgroups with the INN news server.  We are also
working on patches to the INN news server to allow it to deliver
newsgroups via LMTP.

<li> For SNMP monitoring of the IMAP server, AgentX and pthreads is
required.  The CMU implementation is available from our Network
Development group at <a href="http://www.net.cmu.edu/groups/netdev/agentx/">
http://www.net.cmu.edu/groups/netdev/agentx/</a>.

<li> For the Cyrus Murder, the IMAP aggregator, an ACAP server is
required.  You can get an ACAP server from the <a
href="http://asg.web.cmu.edu/asg/">Cyrus project</a>.
</ul>

<H2>Compiling the IMAP Server</H2>

Once you have unpacked the files by extracting the tar archive,
"<TT>cd</TT>" to the "<tt>cyrus-imapd-<i>NNNN</i></tt>" directory
where <i>NNNN</i> is the version number.  The configuration files and
various subdirectories are stored there.  In the directory that the
<TT>configure</TT> file is in, type "<kbd>./configure</kbd>" to
configure the software.

<P>The "<TT>configure</TT>" shell script attempts to guess correct
values for various system-dependent variables used during compilation.
It uses those values to create a "<TT>Makefile</TT>" in each directory
of the package.  Finally, it creates a shell script
"<TT>config.status</TT>" that you can run in the future to recreate
the current configuration, a file "<TT>config.cache</TT>" that saves
the results of its tests to speed up reconfiguring, and a file
"<TT>config.log</TT>" containing compiler output (useful mainly for
debugging "<TT>configure</TT>").

<P>Running "<tt>configure</tt>" takes awhile.  While running, it
prints some messages telling which features it is checking for.

<P>You can compile the package in a different directory from the one
containing the source code.  Doing so allows you to compile it on more
than one kind of computer at the same time.  To do this, you must use
a version of "<TT>make</TT>" that supports the "<tt>VPATH</tt>"
variable, such as GNU "<TT>make</TT>".  "<TT>cd</TT>" to the directory
where you want the object files and executables to go and run the
"<tt>configure</tt>" script.  "<tt>configure</tt>" automatically
checks for the source code in the directory that "<tt>configure</tt>"
is in and in "<tt>..</tt>".

<P>By default, "<TT>make install</TT>" will install files (other than
server-specific programs) in "<TT>/usr/local/bin</TT>",
"<TT>/usr/local/man</TT>", etc.  You can specify an installation
prefix other than "<TT>/usr/local</TT>" by giving "<TT>configure</TT>"
the option "<TT>--prefix=PATH</TT>".

<P>You can specify separate installation prefixes for
architecture-specific files and architecture-independent files.  If
you give "<TT>configure</TT>" the option
"<TT>--exec-prefix=PATH</TT>", the package will use <TT>PATH</TT> as
the prefix for installing programs and libraries.  Documentation and
other data files will still use the regular prefix.

<P>By default, "<TT>make install</TT>" will install the
server-specific programs in "<TT>/usr/cyrus/bin</TT>".  You can
specify a server-specific installation prefix other than
"<TT>/usr/cyrus</TT>" by giving "<TT>configure</TT>" the option
"<TT>--with-cyrus-prefix=PATH</TT>".

<p>Here are a list of switches that can be used with "<A
NAME="configure"><tt>configure</tt></A>".

<dl>
<dt><tt>--help</tt>
<dd>Print a summary of the options to "<tt>configure</tt>", and exit. <P>

<dt><tt>--with-cyrus-user=USER</tt>
<dd>Specifies the userid that the Cyrus IMAP server will run as.  By
default, configure uses "<TT>cyrus</TT>". <P>

<dt><tt>--with-cyrus-group=USER</tt>
<dd>Specifies the group used for installing setguid programs.  By default,
configure uses "<TT>mail</TT>". <P>

<dt><tt>--with-statedir=PATH</tt> 
<dd>Specifies the directory used for communicating with various
daemons.  By default, configure uses "<TT>/var</TT>". <P>

<dt><tt>--with-sasldir=PATH</tt> 
<dd>Specifies the path to the directories containing the library
(<tt>.../lib</tt>) and include (<tt>.../include</tt>)
files for libsasl. <P>

<dt><tt>--with-auth=METHOD</tt>
<dd>Specifies the authorization (group membership) module to use.
Currently implemented authorization modules are:

<dl compact> 
<DT><tt>unix</tt>
<DD>Unix <tt>/etc/passwd</tt> and <tt>/etc/group</tt> file

<DT><tt>krb</tt>
<DD>Kerberos principals (requires Kerberos libraries).  Optionally,
specify where to find Kerberos v4 with "<tt>--with-krb=DIR</tt>"
<B>IMPORTANT:</B> The Kerberos v4 support requires the DES library.
Some vendor distributions of Kerberos, including the one with Solaris,
do not have this support and cannot be used.

<DT><tt>krb_pts</tt>
<DD>Kerberos principals with AFS PTserver groups (requires Kerberos
and AFS libraries).  Optionally, specify where the AFS libraries are
found with "<tt>--with-afs=PATH</tt>".  Also requires krb support as above.

</dl>

Any method of authenticating with SASL can be used with any
authorization module.

<P>

<dt><tt>--with-notify=METHOD</tt>
<dt><tt>--without-notify</tt>
<dd>Specifies the new mail notification method to use.
Currently implemented notification methods are:

<dl compact> 

<DT><tt>zephyr</tt>
<DD>New mail notification through Zephyr.  Specify the location of
the zephyr installation with "<tt>--with-zephyr=PATH</tt>".

<DT><tt>no</tt>
<DD>No new mail notification.

</dl>

By default, uses "<TT>zephyr</TT>" if the Zephyr libraries are available, 
otherwise "<TT>no</TT>".<P>

<dt><tt>--with-openssl=PATH</tt>
<dd>Specifies where to find the OpenSSL library.<P>

<dt><tt>--with-inn=PATH</tt>
<dd>Specifies the location of INN's <TT>NEWSLIB</TT> directory.  By
default, looks for INN in a few common places.  It is only necessary
for "<tt>configure</tt>" to find INN if you are going to export newsgroups
using IMAP. <P>

<dt><tt>--with-tcl=PATH</tt>
<dt><tt>--without-tcl</tt>
<dd>Specifies the path to the Tcl (version 7.5 or 7.6) library and header file (optional).
By default, looks in "<tt>/usr/local</tt>" and then in the compiler's
default link path.  The Tcl library is necessary to compile
"<tt>cyradm</tt>", the administrative client.  If compiling without Tcl, it 
is necessary to give configure the "<TT>--disable-cyradm</TT>" switch. <P>

<dt><tt>--with-lock=METHOD</tt>
<dd>Specifies the locking method to use.  Currently implemented locking
methods are:

<DL compact>

<DT><TT>flock</TT>
<DD><TT>flock()</TT> locking
<DT><TT>fcntl</TT>
<DD><TT>fcntl()</TT> locking
</DL>

By default, uses "<tt>flock</tt>" if the "<tt>flock()</tt>"
function exists, "<tt>fcntl</tt>" otherwise. <P>

<dt><tt>--disable-sieve</tt>
<dd>By default, Sieve support is enabled.  Use
<tt>--disable-sieve</tt> to disable compiling the Sieve library and to
disable all Sieve support.<p>

<dt><tt>--disable-cyradm</tt>
<dd>Do not compile the <TT>cyradm</TT> administrative client.<P>

<dt><tt>--disable-server</tt>
<dd>Do not compile the IMAP server programs.<p>

<dt><tt>--enable-amssync</tt>
<dd>Include AMS (Andrew Message System) to IMAP bboard synchronization
support.  Requires the AMS libraries. <P>
</dl>

"<tt>configure</tt>" ignores any other arguments that you give it.

<P>Some systems require unusual options for compilation or linking
that the "<TT>configure</TT>" script does not know about.  You can
give "<TT>configure</TT>" initial values for variables by setting them
in the environment.  Using a Bourne-compatible shell, you can do that
on the command line like this:

<pre>
   CC=c89 CFLAGS=-O2 LIBS=-lposix ./configure
</pre>

Or on systems that have the "<TT>env</TT>" program, you can do it like this:

<pre>
   env CPPFLAGS=-I/usr/local/include LDFLAGS=-s ./configure
</pre>

The "<tt>make</tt>" variables that you might want to override with
environment variables when running "<tt>configure</tt>" are:

<DL compact>
<DT><TT>CC</TT>
<DD>C compiler program.<br>
Default is "<tt>cc</tt>", or "<tt>gcc</tt>" if "<tt>gcc</tt>" is in
your <tt>PATH</tt>.<br> (For "<tt>CC</tt>", any value given in the
environment <strong>overrides</strong> the value that
"<tt>configure</tt>" would choose.)

<DT><TT>CFLAGS</TT>
<DD>Debugging and optimization options for the C compiler.<br>

<DT><TT>CPPFLAGS</TT>
<DD>Header file search directory ("<tt>-IDIR</tt>") and any other
miscellaneous options for the C preprocessor and compiler.  If it is
not set in the environment when "<tt>configure</tt>" runs, the default value is
empty.<br>

<DT><TT>LDFLAGS</TT>
<DD>Stripping ("<TT>-s</TT>") and any other miscellaneous options for the
linker.  If it is not set in the environment when "<tt>configure</tt>" runs,
the default value is empty. 

<DT><TT>DEFS</TT>
<DD>Configuration options, in the form "<tt>-Dfoo -Dbar ...</tt>"<br>

<DT><TT>LIBS</TT>
<DD>Libraries to link with, in the form "<tt>-lfoo -lbar ...</tt>"<br>
(For "<tt>DEFS</tt>" and "<tt>LIBS</tt>", any value given in the
environment is <strong>added</strong> to the value that
"<tt>configure</tt>" chooses.)
</DL>

If you need to do unusual things to compile the package, we encourage
you to figure out how "<tt>configure</tt>" could check whether to do them, and
mail diffs or instructions to "<tt>cyrus-bugs@andrew.cmu.edu</tt>" so we
can include them in the next release.

<p>The file "<tt>configure.in</tt>" is used as a template to create
"<tt>configure</tt>" by a program called "<tt>autoconf</tt>".  You
will only need it if you want to regenerate "<tt>configure</tt>" using
a newer version of "<tt>autoconf</tt>".

<p>Once you have successfully run "<tt>configure</tt>", execute the
following commands:

<pre>
<kbd>   make depend
   make all CFLAGS=-O
</kbd></pre>

If you want, you can override the "<tt>make</tt>" variables
<tt>CFLAGS</tt> and <tt>LDFLAGS</tt> by entering the following:

<pre>
<kbd>   make all CFLAGS=-O2 LDFLAGS=-s
</kbd></pre>

<h2>Configuring the IMAP Server</h2>

This section describes the shell scripts to run and the configuration 
files to modify once "<tt>configure</tt>" and "<tt>make</tt>" have run.

<ol> <li>Create a user and group for the Cyrus subsystem.  The
examples in this document assume a user of "<tt>cyrus</tt>" and a
group of "<tt>mail</tt>", though any user and group name can be used.
If a user other than "<tt>cyrus</tt>" is to be used, it must have been
previously specified in the "<TT>--with-cyrus-user=</TT>" option to
"<TT>configure</TT>".  If a group other than "<tt>mail</tt>" is to be
used, it must have been previously specified in the
"<TT>--with-cyrus-group=</TT>" option to "<TT>configure</TT>".
 <P>

<li>After you've logged in as "<TT>root</TT>", install the cyrus software.

<pre>
<kbd>   make install
</kbd></pre>

Be sure that the server programs ended up in the directory specified
by "<tt>--with-cyrus-prefix</tt>" (by default, "<tt>/usr/cyrus/bin</tt>").

<p><li>The Cyrus IMAP server uses the 4.3BSD syslog that separates
messages into both levels and categories.  Invoke "<kbd>man
syslog</kbd>" to see if "<tt>openlog()</tt>" takes three arguments. If
it does not, replace the system "<tt>syslogd</tt>" and
"<tt>syslog.conf</tt>" with the files provided in the
"<tt>syslog</tt>" directory.

<pre>
<kbd>   mv syslogd /etc/syslogd
   mv syslog.conf /etc/syslog.conf
</kbd></pre>

If you do not copy the "<tt>syslog/syslog.conf</tt>" file to the 
"<tt>/etc</tt>" directory, be sure to add support for
"<tt>local6.debug</tt>".  The file should include a line like:

<pre>
   local6.debug  /var/log/imapd.log
</pre>

You probably also want to log SASL messages with a line like:
<pre>
   auth.debug /var/log/auth.log
</pre>

After installation and testing, you probably want to change the
".debug" component to something a little less verbose. Create the log
files:

<pre>
<kbd>   touch /var/log/imapd.log /var/log/auth.log
</kbd></pre>

<li>Create the file "<tt>/etc/imapd.conf</tt>". Here is a sample
"<tt>imapd.conf</tt>" with a minimal number of values defined:

<pre>
   configdirectory: /var/imap
   partition-default: /var/spool/imap
   admins: curtj abell
   sasl_pwcheck_method: passwd
</pre>

For a description of all the fields in this file, see the <A
HREF="imapd.conf.5.html"><tt>imapd.conf</tt>(5)</A> man page.  (Note
that this file also exports values to libsasl, the most important of
them the <tt>pwcheck_method</tt>.  In this example, users are
authenticated via the <tt>getpwnam()</tt> call.)
 <P>

Note that <b>everyday users should not be administrators</b>.  Admins
have powers not granted to regular users and while the server allows
them to receive mail, some problems will occur if admins are used as
regular users. You also should <b>not</b> read mail as an
administrator. You should have separate accounts for reading mail and
administrating.

<p>

<li>Decide how users are going to be authenticated.  The easiest
method for authenticating users is to use the libsasl authentication
database and create users using the "<tt>saslpasswd</tt>" utility.
Set "<tt>sasl_pwcheck_method: sasldb</tt>".  Make sure Cyrus
can read "<tt>/etc/sasldb</tt>":

<pre>
<kbd>   chown cyrus /etc/sasldb*
</kbd></pre>

<p>If you want to authenticate users from "<tt>/etc/shadow</tt>",
things are considerably more complicated, since the cyrus user cannot
read the shadow password file.  It is suggested that you configure
libsasl with <tt>pwcheck</tt> support, and set
"<tt>sasl_pwcheck_method: pwcheck</tt>".  The SASL library will then
make calls to an external utility running as root to authenticate
users.

<p>If you're using Kerberos authentication, see <a
href="#kerberos">the section on configuring Kerberos below</a>.

<p><li>Create the configuration directory specified by the
"<tt>configdirectory</tt>" option in "<tt>imapd.conf.</tt>" The
configuration directory is similar in concept to the
"<tt>/usr/lib/news</tt>" directory.  It stores information about the
IMAP server as a whole.

<p>This document uses the configuration directory "<tt>/var/imap</tt>"
in its examples.  This directory should be owned by the
cyrus user and group and should not permit access to other users.


<pre>
<kbd>   cd /var
   mkdir imap
   chown cyrus imap
   chgrp mail imap
   chmod 750 imap
</kbd></pre>

<li>Create the default partition directories specified in the
"<tt>/etc/imapd.conf</tt>" file.

<p>This document uses a default partition directory of 
"<tt>/var/spool/imap</tt>" in the following example:

<pre>
<kbd>   cd /var/spool
   mkdir imap
   chown cyrus imap
   chgrp mail imap
   chmod 750 imap
</kbd></pre>

The partition directory is similar in concept to
<tt>/var/spool/news</tt>.  It is where the mailboxes are stored.
Unlike most netnews systems, Cyrus allows you to have more
than one partition.  Do not use the string "<tt>news</tt>" as a
partition name, as it is reserved for netnews.

<li>If you wish to use Sieve, and you didn't configure deliver to look
in home directories (see the <tt>imapd.conf</tt> man page), create the
Sieve directory:

<pre>
<kbd>   cd /usr
   mkdir sieve
   chown cyrus sieve
   chgrp mail sieve
   chmod 750 sieve
</kbd></pre>

<li>Change to the Cyrus user and use the tool
"<tt>tools/mkimap</tt>" to create the rest of the directories
(subdirectories of the directories you just created).

<pre>
<kbd>   su cyrus
   tools/mkimap
   exit
</kbd>
</pre>

If Perl is not available, it should be easy (but time consuming) to
create these directories by hand. <P>

<li><b>LINUX SYSTEMS ONLY</b>: Set the user, quota, and partition
directories to update synchronously.  Failure to do this may lead to
data corruption and/or loss of mail after a system crash.

<pre>
<kbd>   cd /var/imap
   chattr +S user quota user/* quota/*
   chattr +S /var/spool/imap /var/spool/imap/*
</kbd></pre>

Also set the queue directory of the mail daemon to update
synchronously.  The following example is for sendmail:

<pre>
<kbd>   chattr +S /var/spool/mqueue
</kbd></pre>

<p><li>To enable STARTTLS support, see <a href="#openssl">how to
configure OpenSSL</a> below.

<p><li>Add the following lines to the "<tt>/etc/services</tt>" file if they 
aren't already there.

<pre>
   pop3      110/tcp
   imap      143/tcp
   imsp      406/tcp
   acap      674/tcp
   imaps     993/tcp
   pop3s     995/tcp
   kpop      1109/tcp
   sieve     2000/tcp
   lmtp      2003/tcp
   fud       4201/udp
</pre>
</ol>

<h3>Configuring the Master Process</h3>

<ol>
<li> Choose a configuration from the <tt>master/conf</tt> directory:

   <dl compact>
   <dt><tt>small.conf</tt><dd>bare-bones server supporting IMAP and POP
   <dt><tt>normal.conf</tt><dd>server supporting IMAP, POP, the SSL
   wrapped versions, and the Sieve script management protocol
   <dt><tt>prefork.conf</tt><dd>The same configuration as above, but
   with some preforked processes for faster processing.
   <dt><tt>cmu.conf</tt><dd>Our configuration
   </dl>

<p>To use <tt>normal.conf</tt>, do:
<pre>
<kbd>   cp master/conf/normal.conf /etc/master.conf
</kbd></pre>

<p>Optionally, you can edit <tt>/etc/master.conf</tt> to disable or
enabling certain services, or to tune the number of preforked copies.
Be sure not to remove the entries that are labeled required.

<p><li>Arrange to start "<tt>/usr/cyrus/bin/master</tt>" as root when
the system starts.  It will bind some ports and then give up it's root
privileges.  Until your system reboots, you can start the master
process by hand:

<pre>
<kbd>   /usr/cyrus/bin/master &
</kbd></pre>

<p><li>Monitor the progress of the master process by examining the
<tt>imapd.log</tt> file.  It should never exit by itself, but if you
can shut down the mail system by sending it a signal with <tt>kill</tt>.
</ol>

<h3>Configuring the Mail Transfer Agent</h3>

<p>In order to deliver mail to the Cyrus system, you'll have to
configure your MTA (usually Sendmail) appropriately.

<ol>
<p>You can monitor the master processes's progress by looking at
<tt>/var/log/imapd.log</tt> or wherever you are logging LOCAL6
message.

<P>
<li> Generate a sendmail configuration file which delivers local mail
to the IMAP server.  See the files <TT>cf/README</TT> and
<TT>cf/cf/cyrusproto.mc</TT> in the Sendmail distribution for
information on how to do this.  It is preferable to tell Sendmail to
use LMTP to deliver messages, which enables things such as <a
href="overview.html#singleinstance">single instance store</a>.  Be
sure the sendmail configuration file gets reloaded after you make the
changes.

 <P> <LI> Edit <TT>/etc/group</TT> and add user "<TT>daemon</TT>" to
the "<TT>mail</TT>" group.  This will permit sendmail to run the
"<TT>deliver</TT>" program to deliver mail to the IMAP server.

</ol>

<h3>Exporting Netnews via IMAP</h3>

If you want to export netnews newsgroups using IMAP do the following:

<ol>
 <P><LI>Create a directory for the "news" partition.  This directory
should be different than the news spool directory.  This document uses
a news partition directory of "<TT>/var/spool/imap-news</TT>" in the
following examples:

<pre>
<kbd>   cd /var/spool
   mkdir imap-news
   chown cyrus imap-news
   chgrp mail imap-news
   chmod 750 imap-news
</kbd></pre>

 <P>
<LI> Set the "partition-news" and "newsspool" options to appropriate values:

<pre>
   partition-news: /var/spool/imap-news
   newsspool: /var/spool/news
</pre>

 <P> <LI>The cyrus user must be able to write to the out.going
("<TT>/var/spool/news/out.going</TT>") directory.  This can be done by
putting the cyrus user into the news group and making the oug.going
directory group writable.

 <P>
<LI> Add the following line to the <TT>newsfeeds</TT> file

<pre>
   collectnews!:*:Tf,WO:collectnews
</pre>

 <P> <LI> Add a <TT>cron</TT> job to run
"<TT>/usr/cyrus/bin/feedcyrus</TT>" every ten minutes as the cyrus
user.  Also add a <TT>cron</TT> job to run
"<TT>/usr/cyrus/bin/syncnews /var/news/active &gt;/dev/null
2&gt;&amp;1</TT>" nightly.  (Using the appropriate path to the
<TT>active</TT> file.)

</ol>

<h2>Testing the IMAP Server</h2>

To test the IMAP server, reboot and perform the following steps (all
of these samples use "<tt>foobar</tt>" as the IMAP server name).  A
list of answers to common installation problems is maintained in <A
HREF="http://asg.web.cmu.edu/cyrus/imapd/install-FAQ">http://asg.web.cmu.edu/cyrus/imapd/install-FAQ</A>.

<ol>
<li>From your normal account, telnet to the IMAP port on the
server you're setting up:

<pre>
<kbd>   telnet foobar imap
</kbd></pre>

If your server is running, you'll get the following message:

<pre>
   Trying 128.2.232.95...
   Connected to foobar.andrew.cmu.edu.
   Escape character is '^]'.
   * OK foobar.andrew.cmu.edu Cyrus IMAP4 v2.0.0 server ready
</pre>

<p>
Any message other than one starting with "<tt>* OK</tt>" means there
is a problem.  To terminate the connection, type
	      "<kbd>. logout</kbd>".

<p>Naturally the version number should match the version you just
installed.

<P>
<li>Use "<tt>imtest</tt>" to test logging in with plaintext passwords:

<pre>
<kbd>   /usr/local/bin/imtest -m login foobar
</kbd></pre>

<p>If you want to specify a different user, do:

<pre>
<kbd>   /usr/local/bin/imtest -m login -a <i>USER</i> foobar
</kbd></pre>

If your server is running, you'll get the following message:
<pre>
   <kbd>/usr/local/bin/imtest -m login -p imap foobar</kbd>
   S: * OK mail1.andrew.cmu.edu Cyrus IMAP4 v2.0.0 server ready
   C: C01 CAPABILITY
   S: * CAPABILITY IMAP4 IMAP4rev1 ACL QUOTA LITERAL+ NAMESPACE UIDPLUS 
   X-NON-HIERARCHICAL-RENAME NO_ATOMIC_RENAME AUTH=GSSAPI AUTH=ANONYMOUS 
   AUTH=KERBEROS_V4 UNSELECT
   S: C01 OK Completed
   Password: 
   + go ahead
   L01 OK User logged in
   Authenticated.
   Security strength factor: 0
</pre>

<p>Any message other than one starting with a "<tt>L01 OK</tt>" means there is
a problem.  If the test fails, a more specific error message should be
written through <tt>syslog</tt> to the server log.  To terminate the
connection, type "<kbd>. logout</kbd>".

<li>You should now test the server with each of the various
authentication mechanisms you have installed. The supported mechanisms
are listed in the CAPABILITY line:

<pre>
  * CAPABILITY IMAP4 IMAP4rev1 ACL QUOTA LITERAL+ NAMESPACE UIDPLUS 
  X-NON-HIERARCHICAL-RENAME NO_ATOMIC_RENAME AUTH=ANONYMOUS
  AUTH=KERBEROS_V4 AUTH=DIGEST-MD5 AUTH=CRAM-MD5 UNSELECT
  . OK Completed
</pre>

Each of the mechanism names is preceded by a 'AUTH='. For this example
the ANONYMOUS, KERBEROS_V4, DIGEST-MD5, and CRAM-MD5 mechanisms are
available. If a mechanism does not appear that you wish to use,
examine the libsasl log messages.  Generally, if a mechanism does not
appear, it means it failed to initialize.  (For example, if the server
is unable to access the srvtab file the KERBEROS_V4 mechanism will
refuse to load.)

<p>Plaintext login is a special case: the PLAIN SASL mechanism is only
advertised under an encrypted connection.  However, plaintext logins
are available (as long as you haven't disabled plaintext)
by using <tt>-m login</tt>(as above).

<p>To terminate the <tt>imtest</tt> connection, type "<kbd>. logout</kbd>".

<p>Once you are satisfied with the authentication mechanism list you
should attempt to log in with each of those mechanisms. Run <tt>imtest</tt>
specifying which mechanism you would like to use.

<pre>
   <kbd>/usr/local/bin/imtest -m KERBEROS_V4 foobar</kbd>
   C: C01 CAPABILITY
   S: * OK foobar.andrew.cmu.edu Cyrus IMAP4 v2.0.0 server ready
   S: * CAPABILITY IMAP4 IMAP4rev1 ACL QUOTA LITERAL+ NAMESPACE
   UIDPLUS X-NON-HIERARCHICAL-RENAME NO_ATOMIC_RENAME AUTH=ANONYMOUS
   AUTH=GSSAPI AUTH=KERBEROS_V4 UNSELECT
   S: C01 OK Completed
   C: A01 AUTHENTICATE KERBEROS_V4
   S: + wYcDAA==
   C: BAYBQU5EUkVXLkNNVS5FRFUAOCAm7F/Y+HabCzJ
      /UMtVcvWRjTohuq/USaCV6gYdkAU5DOcADAq
   S: + 0aAsUGQZhgQ=
   C: ADMe/cVivAYYzy1yd4Vojg==
   S: A01 OK Success (privacy protection)
   Authenticated.
   Security strength factor: 56
</pre>

<p>Any message other than one starting with a "<tt>A01 OK</tt>" means there is
a problem. If the test fails, a more specific error message is written
through <TT>syslog</TT> to the server log.  To terminate the
connection, type "<kbd>. logout</kbd>".</p>

<p>See the libsasl documentation for a full description of all the
mechanisms.  It is also possible to support "security layers"
(privacy or integrity protected connections).  By default,
<tt>imtest</tt> uses the strongest layer available with the selected
mechanism; use "<tt>-l</tt>" to choose an alternate layer.</p>

</ol>

<h2>Administering Mailboxes</h2>

The "<tt>cyradm</tt>" command (see the <tt>cyradm</tt>(8) man page for
complete documentation) manages the creation of, deletion of, ACLs on,
and quotas on mailboxes.  To get an overview of the command, type
"<kbd>cyradm <var>&lt;host&gt;</var></kbd>".  Once "<tt>cyradm</tt>" has started,
the user prompt is replaced with the name of the host followed by a
"<tt>&gt;</tt>".  Type "<kbd>help</kbd>" at the new prompt.  The
following information is displayed:

<pre>
   createmailbox, cm        create a mailbox
   deleteaclmailbox, dam    delete an ACL on a mailbox
   deletemailbox, dm        delete a mailbox
   help                     get help on commands
   listaclmailbox, lam      list the ACL on a mailbox
   listmailbox, lm          list mailboxes
   listquota, lq            list quota on root
   listquotaroot, lqr, lqm  list quota roots on mailbox
   quit                     exit program
   renamemailbox, renm      rename a mailbox
   setaclmailbox, sam       set an ACL on a mailbox
   setquota, sq             set quota limits
</pre>

<b>Note:</b>It's not necessary to run "<tt>cyradm</tt>" on the same
system as the IMAP server.

<p><b>Note:</b>If you run "<tt>cyradm</tt>" on a system not using
Kerberos for authentication, you will be prompted for your user name
and password before you can issue any "<tt>cyradm</tt>" commands.  Use
the "<tt>-u</tt>" option to specify a particular user.

<p>The mailbox naming convention requires that the primary mailbox (inbox)
for anyone must be named "<tt>user.<var>&lt;userid&gt;</var></tt>".
To create a mailbox, type:

<pre>
<kbd>   createmailbox user.<var>&lt;userid&gt;</var>
</kbd></pre>

For example, to create a mailbox for the userid "<tt>smith</tt>", type:

<pre>
<kbd>   createmailbox user.smith
</kbd></pre>

To limit "<tt>smith</tt>" to 10,000 kilobytes of mail, type:

<pre>
<kbd>   setquota user.smith 10000
</kbd></pre>

Once the inbox is created, users can create their own additional mailboxes 
from a mail program.  If Smith created a work mailbox and a play mailbox, 
the full names of the mailboxes would be:

<pre>
   user.smith.work
   user.smith.play
</pre>

<p>Access rights are discussed in detail in the <tt>cyradm</tt>(1) man pages.
Note that the administrator must grant herself delete access
explicitly before she can delete a mailbox:

<pre>
<kbd>   setaclmailbox <var>&lt;mail_box&gt;</var> <var>&lt;admin_userid&gt;</var> d
   deletemailbox <var>&lt;mail_box&gt;</var>
</kbd></pre>

Once you have created mailboxes, your IMAP server installation is
done.  You must then configure a mail interface, such as <a
href="http://www.washington.edu/pine/">Pine</a> or <a
href="http://www.cyrusoft.com/mulberry/">Mulberry</a>, to work with the
IMAP server.

<h2>Kerberos</h2><a name="kerberos"/>

<h3>Configuring Kerberos v4</h3>

<p>Cyrus IMAP supports Kerberos v4 if the SASL library was compiled
with KERBEROS_V4 support.</p>

<p>You'll have to 
create a Kerberos v4 identity for the server and add the server's key to
the "<tt>srvtab</tt>" file.  The file must be readable by the cyrus
user. The server's Kerberos identity is "<tt>imap.HOST@REALM</tt>",
where "<tt>HOST</tt>" is the first component of the machine's host
name and "<tt>REALM</tt>" is the machine's Kerberos realm.</p>

<ol>
<li>Here is a sample session, creating a srvtab file for the
host named "<tt>foobar</tt>":

<pre>
<kbd>   ksrvutil -f /var/imap/srvtab add
</kbd></pre>

<p>Here is the information "<tt>ksrvutil</tt>" requests.  Respond by
filling in values or by pressing <KBD>RETURN</KBD>.  In this example,
the host name is "<tt>foobar</tt>" and the realm is 
"<tt>ANDREW.CMU.EDU</tt>".</p>

<pre>
   Name: <kbd>imap</kbd>
   Instance: <KBD>foobar</KBD>
   Realm: <KBD>ANDREW.CMU.EDU</KBD>
   Version number: 
   New principal: imap.foobar@ANDREW.CMU.EDU; version 0
   Is this correct? (y,n) [y] 
   Password: 
   Verifying, please re-enter Password: 
   Key successfully added.
   Would you like to add another key? (y,n) [y] <KBD>n</KBD>
</pre></li>

<li><p>If you plan to install Kerberized POP, create the Kerberos
identity "<tt>pop.HOST@REALM</tt>" and add the key to the "<tt>srvtab</tt>"
file.</p></li>

<li><P>Make the "<TT>srvtab</TT>" file owned by the cyrus user:
<pre>
<kbd>   chown cyrus /var/imap/srvtab
</kbd></pre></li>

<li>Add the option srvtab option to <tt>/etc/imapd.conf</tt>:
<pre>   srvtab: /var/imap/srvtab</pre></li>

<li>Test using <tt>imtest -m KERBEROS_V4</tt>.  <tt>imtest</tt> will
attempt to authorize as the current Unix user regardless of the
current ticket's held.  Override this with the <tt>-u</tt> option.</li>
</ol>

<h3>Troubleshooting Kerberos problems</h3>

<p>Run the program "<tt>krbck</tt>" (found in the <tt>imap</tt>
directory) as the cyrus user on the IMAP server.  This program will
diagnose some common Kerberos v4 configuration errors.</p>

<h3>Configuring Kerberos v5</h3>

<p>Cyrus IMAP supports Kerberos v5 if the SASL library was compiled
with GSSAPI support.</p>

<p>You'll have to create a Kerberos v5 identity for the server.
Kerberos v5 keys are generally stored in "<tt>/etc/krb5.keytab</tt>".

<ol>
<li>Add the "<tt>imap/hostname</tt>" key using "<tt>kadmin</tt>".

<li> Let the cyrus user read "<tt>/etc/krb5.keytab</tt>":
user:
<pre>
<kbd>   chown cyrus /var/imap/srvtab
</kbd></pre></li>

<li>Test using <tt>imtest -m GSSAPI</tt>.  <tt>imtest</tt> will
attempt to authorize as the current Unix user regardless of the
current ticket's held.  Override this with the <tt>-u</tt> option.</li>
</ol>

<h2>SSL, TLS, and OpenSSL</h2><a name="openssl"/>

<p>Transport Layer Security (TLS), is a standardized version of the Secure
Sockets Layer (SSL v3) standard.  IMAP can make use of two different
versions of TLS/SSL: STARTTLS and an SSL wrapped session.</p>

<p>In STARTTLS, a client connects to the IMAP port as normal and then
issues the STARTTLS command, which begins a TLS negotiation.  This is
currently supported by the Cyrus IMAP server when it is compiled with
OpenSSL.</p>

<p>The alternative, a SSL wrapped connection, involves the client
connected to a seperate port ("<tt>imaps</tt>") and negotiating a SSL
session before starting the IMAP protocol.  This is not currently
supported natively by the Cyrus IMAP server.</p>

<p>Both TLS and SSL require a server key and a certificate.
Optionally, in addition to establishing a secure connection, TLS can
authenticate the client.  </p>

<h3>Configuring Cyrus with OpenSSL</h3>

<ol>
<li><p>OpenSSL requires the certificate and key in PEM format.  You can
create the server's private key and certificate yourself using
OpenSSL.  Here, we create a key for the machine
"<tt>cyrus.andrew.cmu.edu</tt>" and put both the certificate and key
in the file "<tt>var/imap/server.pem</tt>".</p>

<p>Please enter the appropriate information for your organization,
instead of Carnegie Mellon University.</p>
<pre>
<kbd>openssl req -new -x509 -nodes -out /var/imap/server.pem -keyout /var/imap/server.pem -days 365</kbd>
Using configuration from /usr/local/lib/openssl/openssl.cnf
Generating a 1024 bit RSA private key
.............+++++
......................+++++
writing new private key to 'FOO'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:<kbd>US</kbd>
State or Province Name (full name) [Some-State]:<kbd>Pennsylvania</kbd>
Locality Name (eg, city) []:<kbd>Pittsburgh</kbd>
Organization Name (eg, company) [Internet Widgits Pty Ltd]:<kbd>Carnegie Mellon University</kbd>
Organizational Unit Name (eg, section) []:<kbd>Andrew Systems Group</kbd>
Common Name (eg, YOUR name) []:<kbd>cyrus.andrew.cmu.edu</kbd>
Email Address []:
</pre></li>

<li>Add the following to <tt>/etc/imapd.conf</tt> to tell the server
where to find the certificate and key file:

<pre>tls_cert_file: /var/imap/server.pem
tls_key_file: /var/imap/server.pem
</pre>
</li>

<li>You can test STARTTLS by using <tt>imtest</tt>:
<pre><kbd>imtest -t "" cyrus.example.org
</kbd></pre>

</ol>

<h3>Client-side certificates</h3>

<p>write me!</p>

<p>Unfortunately, there's no standard on how to
convert the client's authenticate DN (distinguished name) to a SASL
authentication name.</p>

<h2>Sieve</h2>

<p>This section assumes that you compiled Cyrus with sieve support: you
did not specify <tt>--disable-sieve</tt>.  You can find a brief
introduction to Sieve at <a href="http://www.cyrusoft/sieve/">Cyrusoft
International</a>.</p>

<h3>Managing Sieve Scripts</h3>

Since Cyrus is based around the concept of a sealed-server, the normal
way for users to manipulate Sieve scripts is through the
"<tt>installsieve</tt>" utility.

<h3>Testing the sieve server</h3>
<ol>

<p>
<li>The Sieve server, "<tt>timsieved</tt>", is used for transporting
user Sieve scripts to the sealed IMAP server.  It is incompatible with
the "<tt>sieveusehomedir</tt>" option.  It is named after the
principal author, Tim Martin, who desperately wanted something named
after him in the Cyrus distribution.

<p>
<li>From your normal account, telnet to the sieve port on the
server you're setting up:

<pre>
<kbd>   telnet foobar sieve
</kbd></pre>

If your server is running, you'll get a message similar to the following one:

<pre>
   Trying 128.2.10.192...
   Connected to cyrus-dev.andrew.cmu.edu.
   Escape character is '^]'.
   "CMU Experimental Sieved version 0.99" "SASL={GSSAPI, ANONYMOUS, PLAIN, KERBEROS_V4}"
</pre>

<p>
Any message other than one similar to the one above means there is a
problem. Make sure all of authentication methods you wish to support
are listed. This list should be identical to the one listed by
"<tt>imapd</tt>" earlier. Next terminate the connection, by typing
    "<kbd>logout</kbd>".

<p>
<li>Next test authenticating to the sieve server. To do this run the
"<tt>installsieve</tt>" utility. You must specify the server. You may
have to specify the port if you run this utility from a different
machine without the "sieve" entry in "<tt>/etc/services</tt>". To
specify the port use the "<tt>-p [port]</tt>" switch.

<pre>
  "<kbd>installsieve foobar</kbd>"
</pre>

This should produce the message "<tt>Authentication failed</tt>" with
a description of the failure if there was a problem.

<p><li>Next you should attempt to place a sieve script on the
server. To do this create a file named "<tt>myscript.script</tt>" with
the following lines. Replace "<tt>foo@bar.org</tt>" with an email
address you can send mail from, but that is not the one you are
working on now.

<pre>
  require ["reject","fileinto"];

  if address :is :all "From" "foo@bar.org"
  {
    reject "testing";
  }
</pre>

To place this script on the server run the following command

"<kbd>installsieve -i myscript.script foobar</kbd>"

This should place your script on the server and make it the active script.

<p>
<li>Test that the sieve script is actually run from deliver. Send
a message to the address you're working on from the address mentioned
in the sieve script. The message should be rejected.

</ol>

<h2>SNMP Monitoring</h2>

<p>finish this section.  Cyrus uses an auxillary process called
"<tt>tugowar</tt>", so named because there's a push-pull model.
Various components of the Cyrus mail system push data to
<tt>tugowar</tt>, and <tt>tugowar</tt> listens for SNMP queries
(remote clients pull the data from <tt>tugowar</tt>).</p>

<h3>Configuring tugowar</h3>

<h3>Testing the tugowar daemon</h3>

<h3>SNMP data exported</h3>

<h2>The Cyrus Murder: an aggregation of IMAP servers</h2>

<p>see <a
href="http://asg.web.cmu.edu/cyrus/ag.html">http://asg.web.cmu.edu/cyrus/ag.html</a>.</p>

<h2>Performance Notes</h2>

If your configuration directory is not <tt>/var/imap</tt>, adjust
	accordingly. 

<p>
<ul>
<li><tt><b>/var/imap/proc</b></tt> - After a successful login, the imapd
creates a file in <tt>/var/imap/proc</tt> that is its unix process
id. It also contains the name of any <tt>SELECT</tt>'d mailbox. The
file is deleted when the user logs out.

<p>Given the potential load, this is a good candidate to move
elsewhere. This can be done by symlink'ing the directory to another
partition. We symlink it to a directory on a memory/viritual memory
filesystem (specifically Solaris' tmpfs). If you use a tmpfs type
filesystem, make sure that you have sufficient memory/swap to do this.

<p><li><tt><b>/var/imap/deliverdb</b></tt> - Unless you disable
duplicate delivery suppression, each time a mail message is delivered
it needs to lock the database and check to see if the message-id has
been seen already. If you require really high throughput delivery, you
may want to disable this feature.  However, disabling this feature
also disables Sieve support.

<p>We run with it enabled and it doesn't significantly impact our
performance.

<p><li><tt><b>/var/spool/mqueue</b></tt> - Sendmail can be pretty
harsh on the spool partition. Having this on a separate disk is
usually a good idea.  Consider using LMTP and delivering from a
separate machine.

</ul>

<P><HR><P>
<!-- hhmts start -->
Last modified: 09-Mar-2000
<!-- hhmts end -->
</BODY></HTML>
